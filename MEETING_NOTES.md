# –ó–≤—ñ—Ç –ø—Ä–æ —Ä–æ–±–æ—Ç—É: –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è AI-—á–∞—Ç—É –∑ –±–µ–∫–µ–Ω–¥–æ–º —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –ø–æ—à—É–∫—ñ–≤

## üìã –ó–∞–≥–∞–ª—å–Ω–∏–π –æ–≥–ª—è–¥

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –ø–æ–≤–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é AI-—á–∞—Ç—É –∑ –±–µ–∫–µ–Ω–¥ API, –¥–æ–¥–∞–Ω–æ —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –¥–ª—è —á–∞—Ç—É, –º–µ—Ö–∞–Ω—ñ–∑–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫—ñ–≤, –∞ —Ç–∞–∫–æ–∂ –ø—ñ–¥—Ç—Ä–∏–º–∫—É –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –∑–∞ ID –ø—Ä–æ–¥—É–∫—Ç—ñ–≤.

---

## üéØ –©–æ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ

### 1. **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –±–µ–∫–µ–Ω–¥ API**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
- –ß–∞—Ç —Ç–µ–ø–µ—Ä –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –±–µ–∫–µ–Ω–¥ —ñ –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ AI
- –Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —á–∞—Ç—É
- –ö–æ–∂–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π `guestId`, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**
- **API endpoints:**
  - `POST /api/chat/message` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ AI
  - `GET /api/chat/history?guestId={id}` ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É
- **–§—É–Ω–∫—Ü—ñ—ó –≤ `src/lib/api.ts`:**
  - `sendChatMessage()` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  - `getChatHistory()` ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ `guestId`
- **–£—Ç–∏–ª—ñ—Ç–∞ `getOrCreateGuestId()`** (`src/utils/chatUtils.ts`):
  - –ì–µ–Ω–µ—Ä—É—î UUID —á–µ—Ä–µ–∑ `crypto.randomUUID()` –∞–±–æ fallback
  - –ó–±–µ—Ä—ñ–≥–∞—î –≤ `localStorage` –ø—ñ–¥ –∫–ª—é—á–µ–º `chatGuestId`
  - –ü–æ–≤–µ—Ä—Ç–∞—î —ñ—Å–Ω—É—é—á–∏–π ID, —è–∫—â–æ –≤—ñ–Ω –≤–∂–µ —î

---

### 2. **–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π AI**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
AI –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —É —Ñ–æ—Ä–º–∞—Ç—ñ Markdown (–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–∫–∏, –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–æ—â–æ). –¶—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∫–æ—Ä–µ–∫—Ç–Ω–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ —á–∞—Ç—É.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**
- **–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏:** `react-markdown` (v10.1.0) + `rehype-raw` (v7.0.0)
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç `ChatMessage.tsx`:**
```typescript
{isAi ? (
  <ReactMarkdown rehypePlugins={[rehypeRaw]}>
    {message.content}
  </ReactMarkdown>
) : (
  <span>{message.content}</span>
)}
```
- `rehype-raw` –¥–æ–∑–≤–æ–ª—è—î —Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ HTML, —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ –≤ Markdown

---

### 3. **–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –¥–ª—è —á–∞—Ç—É**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
AI –æ—Ç—Ä–∏–º—É—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–µ, –Ω–∞ —è–∫—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —ñ —è–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ñ. –¶–µ –¥–æ–∑–≤–æ–ª—è—î AI –¥–∞–≤–∞—Ç–∏ –±—ñ–ª—å—à —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**

**–¢–∏–ø–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:**
1. **`product`** ‚Äî –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ–¥–∏–Ω–Ω–∏–∫–∞
   - –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è `entityId` (UUID –≥–æ–¥–∏–Ω–Ω–∏–∫–∞)
   - –ú–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏, —è–∫—â–æ –≤–æ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ
2. **`search`** ‚Äî –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–∞—Ç–∞–ª–æ–≥—É –∑ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
   - –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –æ–±'—î–∫—Ç `filters` –∑ –≥—Ä—É–ø–∞–º–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** `product` > `search` (—è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —Ç–æ–≤–∞—Ä—É, –∑–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è `product`, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏)

**–§—É–Ω–∫—Ü—ñ—è `getChatContext()`** (`src/utils/chatUtils.ts`):
```typescript
export function getChatContext(
  currentPath: string,
  watchId?: string,
  savedFilters?: { searchTerm: string; filters: string[] } | null
): ChatContext | undefined
```

**–õ–æ–≥—ñ–∫–∞:**
- –Ø–∫—â–æ `pathname.includes('/product/')` —ñ —î `watchId` ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î `{ type: 'product', entityId: watchId }`
- –Ø–∫—â–æ `pathname.includes('/catalog')` —ñ —î `savedFilters` ‚Üí –ø–æ–≤–µ—Ä—Ç–∞—î `{ type: 'search', filters: {...} }`
- –Ü–Ω–∞–∫—à–µ ‚Üí `undefined`

**–§—É–Ω–∫—Ü—ñ—è `convertFiltersToContext()`:**
- –ö–æ–Ω–≤–µ—Ä—Ç—É—î –º–∞—Å–∏–≤ —Ä—è–¥–∫—ñ–≤ —Ñ–æ—Ä–º–∞—Ç—É `"brand:Rolex"` –≤ –æ–±'—î–∫—Ç `ChatContextFilters`:
```typescript
{
  brands: ['Rolex'],
  materials: ['Steel'],
  conditions: ['New'],
  // ...
}
```

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ `ChatMenu.tsx`:**
- –ü—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `getWatchIdFromPath()` –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è ID –∑ URL
- –§–æ—Ä–º—É—î—Ç—å—Å—è `chatContext` —ñ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ `sendChatMessage()`

---

### 4. **–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—à—É–∫—ñ–≤ —É —á–∞—Ç—ñ**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –ø–æ—à—É–∫ (—Ç–µ–∫—Å—Ç + —Ñ—ñ–ª—å—Ç—Ä–∏) —É —á–∞—Ç. –¶–µ —Å—Ç–≤–æ—Ä—é—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ, —è–∫–µ –º–æ–∂–Ω–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏, —â–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ü—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑–Ω–æ–≤—É.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**

**–•—É–∫ `useSaveSearchToChat`** (`src/hooks/useSaveSearchToChat.ts`):
- –ü—Ä–∏ –≤–∏–∫–ª–∏–∫—É `saveSearchToChat()` —Ñ–æ—Ä–º—É—î —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
- –°—Ç–≤–æ—Ä—é—î –æ–±'—î–∫—Ç `Message` –∑ –ø–æ–ª—è–º–∏:
  - `isSaved: true`
  - `savedSearch: { searchTerm: string, filters: string[] }`
- –ó–±–µ—Ä—ñ–≥–∞—î –≤ `localStorage` –ø—ñ–¥ –∫–ª—é—á–µ–º `savedChatSearches` (–æ–∫—Ä–µ–º–æ –≤—ñ–¥ –æ—Å–Ω–æ–≤–Ω–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó)
- –î–æ–¥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –º–µ–Ω—é —á–∞—Ç—É

**–§—É–Ω–∫—Ü—ñ—ó –≤ `src/utils/chatUtils.ts`:**
- `saveSearchToStorage()` ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ localStorage
- `getSavedSearches()` ‚Äî –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—à—É–∫–∏
- `removeSavedSearch()` ‚Äî –≤–∏–¥–∞–ª—è—î –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –ø–æ—à—É–∫

**–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —á–∞—Ç—É:**
- –ü—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —á–∞—Ç—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è —ñ—Å—Ç–æ—Ä—ñ—è –∑ –±–µ–∫–µ–Ω–¥—É
- –î–æ –Ω–µ—ó –¥–æ–¥–∞—é—Ç—å—Å—è –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—à—É–∫–∏ –∑ localStorage
- –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—à—É–∫–∏ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º—ñ, –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

---

### 5. **–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∫–∞—Ç–∞–ª–æ–≥—É**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –ø–æ—à—É–∫ —É —á–∞—Ç—ñ, –≤—ñ–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∫–∞—Ç–∞–ª–æ–≥—É, —ñ –≤—Å—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**

**–ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö:**
1. **–ö–ª—ñ–∫ –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –ø–æ—à—É–∫** (`ChatMessage.tsx`):
   ```typescript
   setSavedCatalogFilters(message.savedSearch);
   router.push(`/${locale}/catalog`);
   ```

2. **–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤** (`src/features/catalog/page.tsx`):
   - `useEffect` —Å–ª—É—Ö–∞—î –∑–º—ñ–Ω–∏ `savedCatalogFilters`
   - –ü–∞—Ä—Å–∏—Ç—å –º–∞—Å–∏–≤ `filters` (—Ñ–æ—Ä–º–∞—Ç `"brand:Rolex"`) –≤ –æ–∫—Ä–µ–º—ñ –º–∞—Å–∏–≤–∏:
     - `selectedBrands`, `selectedConditions`, `selectedMechanisms`, —Ç–æ—â–æ
   - –í–∏–∫–ª–∏–∫–∞—î:
     - `search.setSearchTerm()` ‚Äî —è–∫—â–æ —î —Ç–µ–∫—Å—Ç –ø–æ—à—É–∫—É
     - `search.applySidebarFilters()` ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Ñ—ñ–ª—å—Ç—Ä–∏ —Å–∞–π–¥–±–∞—Ä—É
     - `search.setSelectedIndexes()` ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —ñ–Ω–¥–µ–∫—Å–∏ (A/B/C)
   - –í—Å—Ç–∞–Ω–æ–≤–ª—é—î `savedCatalogFilters = null` –ø—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

3. **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö** (`useEffect` –≤ `page.tsx`):
   - –°–ª—É—Ö–∞—î –∑–º—ñ–Ω–∏ `search.sidebarFilters` —ñ `search.searchTerm`
   - –Ø–∫—â–æ `isApplyingSavedFiltersRef.current === true`, –≤–∏–∫–ª–∏–∫–∞—î `search.reloadWithFilters()`
   - –¶–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≥–æ–¥–∏–Ω–Ω–∏–∫–∏ –∑ –±–µ–∫–µ–Ω–¥—É –∑ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏

**–í–∞–∂–ª–∏–≤–æ:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `useRef` (`isApplyingSavedFiltersRef`) –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
- –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –∑–∞–π–≤–∏–º –≤–∏–∫–ª–∏–∫–∞–º API –ø—ñ–¥ —á–∞—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤

---

### 6. **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –∑–∞ ID –ø—Ä–æ–¥—É–∫—Ç—ñ–≤**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
AI –º–æ–∂–µ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≥–æ–¥–∏–Ω–Ω–∏–∫–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —ó—Ö UUID –∑–∞–º—ñ—Å—Ç—å slug. –°—Ç–æ—Ä—ñ–Ω–∫–∞ –ø—Ä–æ–¥—É–∫—Ç—É —Ç–µ–ø–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î –æ–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**

**–û–Ω–æ–≤–ª–µ–Ω–Ω—è `src/app/[locale]/product/[slug]/page.tsx`:**
- –§—É–Ω–∫—Ü—ñ—è `isUUID()` –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä `slug` —î UUID
- `generateMetadata()` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `getWatchById()` –¥–ª—è UUID –∞–±–æ `getWatchBySlug()` –¥–ª—è slug

**–û–Ω–æ–≤–ª–µ–Ω–Ω—è `ProductClient.tsx`:**
- –ü—Ä–∏–π–º–∞—î `identifier` (–º–æ–∂–µ –±—É—Ç–∏ slug –∞–±–æ ID)
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –º–µ—Ç–æ–¥ API –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É

**–ö–µ—à—É–≤–∞–Ω–Ω—è –≤ `ChatMenu.tsx`:**
- –§—É–Ω–∫—Ü—ñ—è `getWatchIdFromPath()` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∫–µ—à –≤ localStorage
- –ö–ª—é—á: `slug-to-id-cache-{slug}`
- TTL: 24 –≥–æ–¥–∏–Ω–∏
- –¶–µ –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –≥–æ–¥–∏–Ω–Ω–∏–∫–∞ –∑—ñ slug –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

---

### 7. **–ö–æ–Ω—Å–æ–ª—ñ–¥–∞—Ü—ñ—è –ª–æ–≥—ñ–∫–∏ —á–∞—Ç—É**

**–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ:**
–í—Å—è –ª–æ–≥—ñ–∫–∞ —á–∞—Ç—É –∑–æ—Å–µ—Ä–µ–¥–∂–µ–Ω–∞ –≤ –æ–¥–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ `ChatMenu.tsx` –∑–∞–º—ñ—Å—Ç—å —Ä–æ–∑–ø–æ–¥—ñ–ª—É –º—ñ–∂ –∫—ñ–ª—å–∫–æ–º–∞ —Ñ–∞–π–ª–∞–º–∏.

**–¢–µ—Ö–Ω—ñ—á–Ω–æ:**
- –í–∏–¥–∞–ª–µ–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `AiChat.tsx` (–±—É–≤ –∑–∞–π–≤–∏–º, –±–æ –Ω–µ–º–∞—î –æ–∫—Ä–µ–º–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —á–∞—Ç—É)
- –í—Å—è –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ `ChatMenu.tsx`:
  - –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
  - –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
  - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è `guestId`
  - –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
  - –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫

---

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
- `react-markdown@^10.1.0` ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ Markdown
- `rehype-raw@^7.0.0` ‚Äî –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ HTML –≤ Markdown
- –û–Ω–æ–≤–ª–µ–Ω–æ `react` —Ç–∞ `react-dom` –¥–æ `^19.2.1`
- –û–Ω–æ–≤–ª–µ–Ω–æ `next` –¥–æ `^15.5.7`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

**`Message` —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```typescript
{
  content: string;
  by: 'me' | 'ai';
  id: number;
  time?: string;
  isSaved?: boolean;
  savedSearch?: {
    searchTerm: string;
    filters: string[];
  };
}
```

**`ChatContext` —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
```typescript
{
  type: 'product' | 'search';
  entityId?: string; // –¥–ª—è product
  filters?: ChatContextFilters; // –¥–ª—è search
}
```

### LocalStorage –∫–ª—é—á—ñ
- `chatGuestId` ‚Äî UUID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- `chatMessages` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ –±–µ–∫–µ–Ω–¥–æ–º)
- `savedChatSearches` ‚Äî –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—à—É–∫–∏ (–æ–∫—Ä–µ–º–æ)
- `slug-to-id-cache-{slug}` ‚Äî –∫–µ—à –¥–ª—è –º–∞–ø—ñ–Ω–≥—É slug ‚Üí ID

---

## üêõ –í–∏—Ä—ñ—à–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

1. **–ü–æ–º–∏–ª–∫–∞ –∑ `flushSync` –≤ `useLayoutEffect`:**
   - –ü—Ä–æ–±–ª–µ–º–∞: React –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `flushSync` –ø—ñ–¥ —á–∞—Å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É
   - –†—ñ—à–µ–Ω–Ω—è: –ó–∞–º—ñ–Ω–µ–Ω–æ `useLayoutEffect` + `flushSync` –Ω–∞ –∑–≤–∏—á–∞–π–Ω–∏–π `useEffect`

2. **–§—ñ–ª—å—Ç—Ä–∏ –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –∑ —á–∞—Ç—É:**
   - –ü—Ä–æ–±–ª–µ–º–∞: `useEffect` –≤ `useCatalogSearch` —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–≤ —Ä–∞–Ω—ñ—à–µ, –Ω—ñ–∂ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞–ª–∏—Å—å —Ñ—ñ–ª—å—Ç—Ä–∏
   - –†—ñ—à–µ–Ω–Ω—è: –î–æ–¥–∞–Ω–æ `isApplyingSavedFiltersRef` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é —Å—Ç–∞–Ω—É —Ç–∞ –æ–∫—Ä–µ–º–∏–π `useEffect` –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö

3. **TypeScript –ø–æ–º–∏–ª–∫–∏ –∑ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–º–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏ —Å—Ç–∞–Ω—É:**
   - –ü—Ä–æ–±–ª–µ–º–∞: `setMessages` –Ω–µ –ø—Ä–∏–π–º–∞–≤ —Ñ—É–Ω–∫—Ü—ñ—é `(prev) => [...prev, new]`
   - –†—ñ—à–µ–Ω–Ω—è: –û–Ω–æ–≤–ª–µ–Ω–æ —Ç–∏–ø –≤ `IMainContext` —Ç–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é –≤ `MainContext`

---

## üìù –í–∏—Å–Ω–æ–≤–æ–∫

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é AI-—á–∞—Ç—É –∑ –±–µ–∫–µ–Ω–¥–æ–º, —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π AI, –º–µ—Ö–∞–Ω—ñ–∑–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫—ñ–≤, –∞ —Ç–∞–∫–æ–∂ –ø—ñ–¥—Ç—Ä–∏–º–∫—É –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –∑–∞ ID –ø—Ä–æ–¥—É–∫—Ç—ñ–≤. –í—Å—è –ª–æ–≥—ñ–∫–∞ –∫–æ–Ω—Å–æ–ª—ñ–¥–æ–≤–∞–Ω–∞ –≤ –æ–¥–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ –¥–ª—è –∫—Ä–∞—â–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.

